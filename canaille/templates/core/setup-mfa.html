{# The multi-factor authentication initialization template.

Display a QR-code and the OTP secret.

:param user: The user initializing the OTP.
:type user: :class:`~canaille.core.models.User`
:param secret: The OTP secret.
:type secret: :class:`str`
:param qr_image: A QR-code image representing the OTP secret.
:type qr_image: A base64 encoded :class:`str`
#}
{% extends theme('base.html') %}
{% import 'macro/flask.html' as flask %}
{% import 'macro/form.html' as fui %}
{% import 'core/partial/login_field.html' as login_field %}

{% block container %}
    <div class="ui container">
        <div class="content">
            <div class="ui clearing segment">
                {% block header %}
                    {% if logo_url %}
                        <a href="{{ url_for('core.account.index') }}">
                            <img class="ui tiny centered image" src="{{ logo_url }}" alt="{{ website_name }}">
                        </a>
                    {% else %}
                        <i class="massive sign in icon image ui"></i>
                    {% endif %}

                    <h2 class="ui center aligned header">
                        <div class="content">
                            {{ _("Sign in as %(username)s", username=user.user_name) }}
                        </div>
                        <div class="sub header">{% trans %}Set up multi-factor authentication.{% endtrans %}</div>
                    </h2>
                {% endblock %}

                {% block messages %}
                    {{ flask.messages() }}
                {% endblock %}

                <div class="ui segment">
                    <h3 class="ui header">{% trans %}Instructions{% endtrans %}</h3>
                    <ol class="ui list">
                        <li class="item">{% trans %}Install a One-Time Password (OTP) generator application on your mobile.{% endtrans %}</li>
                        <li class="item">{% trans %}Set up a new authenticator.{% endtrans %}</li>
                        <li class="item">{% trans %}Scan the QR code below and click "Continue".{% endtrans %}</li>
                    </ol>
                    <p>
                        <strong>{% trans %}Note:{% endtrans %}</strong>
                        {% trans %}If you can't scan the QR code, try entering the secret token in your authenticator app directly.{% endtrans %}
                    </p>
                </div>
                <div>
                    <img src="data:image/png;base64, {{ qr_image }}" alt="{% trans %}Secret token{% endtrans %}" class="ui centered medium image"/>
                </div>
                <form class="ui segment grid action input">
                    <label class="ui large label token-label" for="secret">{% trans %}Secret token:{% endtrans %}</label>
                    <input type="text" id="secret" name="secret" value="{{ secret }}" readonly>
                    <button type="button" class="ui secondary right labeled icon button" onclick="copySecret(this)">
                        {% trans %}Copy secret{% endtrans %}
                    </button>
                </form>
                {% block buttons %}
                    <div class="ui right aligned container">
                        <div class="ui stackable buttons">
                            <a type="button" class="ui right floated primary button" href="{{ url_for('core.auth.verify_two_factor_auth') }}">
                                {{ _("Continue") }}
                            </a>
                        </div>
                    </div>
                {% endblock %}
            </div>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script>
        function copySecret(clickedButton) {
            var copyText = document.getElementById("secret");
            copyText.select();
            copyText.setSelectionRange(0, 99999); /*For mobile devices*/
            document.execCommand("copy");
            clickedButton.textContent = "{{ _("Successfully copied!")|safe }}";
            setTimeout(() => {
                clickedButton.textContent = "{{ _("Copy secret")|safe }}";
            }, 2000);
        }
    </script>
{% endblock %}
